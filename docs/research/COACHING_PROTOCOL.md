# Coaching Protocol: Differential Fuzzing Methodology

**Version:** 1.0.0
**Status:** Active Protocol
**Last Updated:** 2024-12-18

## Overview

The Coaching Protocol defines how `pm_coach` ensures feature parity between Python and Rust implementations of pm_encoder through **Differential Fuzzing Against Real-World Data**.

## The Standard

```
0 bytes difference allowed
```

When both engines process the same repository, their outputs must be **byte-identical**. Any difference, no matter how small, represents a parity gap that must be resolved.

## Definitions

### Differential Fuzzing
A testing technique that runs two implementations on the same input and compares their outputs. Unlike traditional fuzzing (which looks for crashes), differential fuzzing catches semantic differences.

### Real-World Data
Actual GitHub repositories serve as test inputs. This catches edge cases that synthetic tests miss:
- Unicode file names
- Binary detection edge cases
- Complex directory structures
- Various file encodings
- Platform-specific files

### The Coaching Loop

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   HARVEST   │ --> │   COMPARE   │ --> │  MINIMIZE   │ --> │  VECTORIZE  │
│             │     │             │     │             │     │             │
│ Clone repos │     │ Run both    │     │ Find minimal│     │ Create test │
│ from GitHub │     │ engines     │     │ reproduction│     │ vector JSON │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
       │                                                           │
       └───────────────────────────────────────────────────────────┘
                            (iterate until 100% parity)
```

## Modes of Operation

### 1. Differential Mode (Default)

Compares stdout output from both engines:

```bash
pm_coach https://github.com/user/repo
```

**What it tests:**
- Plus/Minus format serialization
- File ordering
- Content encoding
- Truncation behavior
- Analyzer output

### 2. Artifact Mode (`--check-init`)

Compares files generated by `--init-prompt`:

```bash
pm_coach https://github.com/user/repo --check-init
```

**What it tests:**
- Split Brain architecture compliance
- CLAUDE.md / GEMINI_INSTRUCTIONS.txt generation
- CONTEXT.txt serialization
- Directory tree generation
- Command detection

**Workflow:**
1. Clone repository to temp directory
2. Run `pm_encoder . --init-prompt` (Python)
3. Move `CLAUDE.md` → `temp/py_CLAUDE.md`
4. Move `CONTEXT.txt` → `temp/py_CONTEXT.txt`
5. Run `pm_encoder . --init-prompt` (Rust)
6. Move `CLAUDE.md` → `temp/rs_CLAUDE.md`
7. Move `CONTEXT.txt` → `temp/rs_CONTEXT.txt`
8. Diff both pairs of files
9. Report: PASS (0 bytes diff) or FAIL (with diff details)

## Pre-Release Workflow

Before any release, run the coaching suite:

### Step 1: Build Release Binaries

```bash
cd rust && cargo build --release
```

### Step 2: Run Differential Tests

```bash
# Single repo quick check
pm_coach https://github.com/psf/requests

# Full test suite (from repos.txt)
pm_coach repos.txt --output release_check/
```

### Step 3: Run Artifact Tests

```bash
# Test --init-prompt parity
pm_coach https://github.com/psf/requests --check-init

# Test with Gemini target
pm_coach https://github.com/psf/requests --check-init --ai-target gemini
```

### Step 4: Review Results

```bash
# Check summary
cat release_check/results.json | jq '.[] | select(.match == false)'

# If failures exist, generate vectors for investigation
pm_coach failing_repo --generate-vectors
```

## Failure Classification

| Type | Description | Action |
|------|-------------|--------|
| `OUTPUT_MISMATCH` | Different serialized content | Compare line-by-line |
| `CHECKSUM_MISMATCH` | Same content, different order | Fix sorting logic |
| `MISSING_FILE` | Rust missing a file Python includes | Fix glob/ignore patterns |
| `EXTRA_FILE` | Rust includes extra file | Fix ignore patterns |
| `ENCODING_DIFF` | Unicode/encoding differences | Fix encoding handling |
| `ARTIFACT_MISMATCH` | Generated files differ | Fix init-prompt logic |
| `PYTHON_CRASH` | Python engine crashed | Debug Python |
| `RUST_CRASH` | Rust engine crashed | Debug Rust |

## Test Vector Generation

When a failure is found, generate a minimal reproduction:

```bash
pm_coach https://github.com/user/failing_repo --generate-vectors
```

This creates `pm_coach_results/vector_failing_repo.json`:

```json
{
  "name": "pm_coach_failing_repo",
  "description": "Auto-generated from https://github.com/user/failing_repo",
  "category": "differential",
  "failure_type": "output_mismatch",
  "repo_url": "https://github.com/user/failing_repo",
  "expected": {
    "match": true,
    "failure_type": "none"
  },
  "actual": {
    "match": false,
    "failure_type": "output_mismatch",
    "diff_summary": "Output differs (5 added, 3 removed)"
  }
}
```

## Repository Selection

### Quick Smoke Test
```bash
pm_coach https://github.com/psf/requests
```

### Recommended Test Set

Create `repos.txt` with diverse repositories:

```text
# Python projects
https://github.com/psf/requests
https://github.com/django/django
https://github.com/pallets/flask

# Rust projects
https://github.com/rust-lang/rust
https://github.com/BurntSushi/ripgrep

# JavaScript projects
https://github.com/facebook/react
https://github.com/expressjs/express

# Mixed/Complex
https://github.com/torvalds/linux
https://github.com/microsoft/vscode
```

### Edge Case Repositories

Include repos known to stress edge cases:
- Repos with Unicode filenames
- Repos with binary files
- Very large repos
- Repos with symlinks
- Repos with submodules

## Success Criteria

| Metric | Target |
|--------|--------|
| Differential Parity | 100% |
| Artifact Parity | 100% |
| Byte Difference | 0 |
| Performance (Rust vs Python) | Rust ≥ 10x faster |

## Integration with CI/CD

### GitHub Actions Example

```yaml
name: Parity Check

on:
  pull_request:
    branches: [main]

jobs:
  parity:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Rust
        run: cd rust && cargo build --release

      - name: Run Parity Tests
        run: |
          python -m pm_coach https://github.com/psf/requests
          python -m pm_coach https://github.com/psf/requests --check-init

      - name: Check Results
        run: |
          if grep -q '"match": false' pm_coach_results/results.json; then
            echo "Parity check failed!"
            exit 1
          fi
```

## Troubleshooting

### Common Issues

**1. "Cannot find pm_encoder.py"**
Run pm_coach from the project root directory.

**2. "Rust binary not found"**
Build the release binary: `cd rust && cargo build --release`

**3. Clone timeout**
Some repos are very large. Use `--timeout 300` for large repos.

**4. Different Python versions**
Ensure both engines use the same Python version for consistency.

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0.0 | 2024-12-18 | Initial protocol with artifact mode support |

## References

- [pm_encoder Documentation](../../README.md)
- [Test Vectors](../../test_vectors/README.md)
- [Rust Implementation](../../rust/README.md)
