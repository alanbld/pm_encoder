# v1.7.0 - The Intelligence Update

**Status:** PENDING GitHub Release
**Tag:** v1.7.0 (already pushed)
**Date:** 2025-12-17

---

## Release Command

Once GitHub access is restored, run:

```bash
gh release create v1.7.0 \
  --title "v1.7.0 - The Intelligence Update" \
  --notes-file docs/releases/v1.7.0_PENDING.md
```

---

## Release Notes

### The Intelligence Update

**pm_encoder transitions from "Dumb Pipe" to "Smart Curator".**

This release introduces the **Intelligence Layer** - a system that understands context economics and maximizes information density within token constraints.

### Added - The Intelligence Layer ðŸ§ 

- **Token Budgeting**: New `--token-budget` flag (e.g., `100k`, `2M`) to limit output size
- **Priority Groups**: Lenses now support `groups` with numeric priorities (0-100)
- **Hybrid Strategy**: New `--budget-strategy hybrid` automatically truncates massive files to Structure Mode to fit them into the budget, rather than dropping them
- **Token Estimation**: Optional `tiktoken` integration for precise counting, with heuristic fallback (~4 chars/token)

### Changed

- **Batch Mode**: Budgeting automatically disables streaming to perform global priority sorting
- **Budget Report**: Detailed stderr report showing token usage, dropped/truncated files, and strategy applied

### New CLI Flags

```bash
# Token budget with shorthand notation
--token-budget 100k    # 100,000 tokens
--token-budget 2M      # 2,000,000 tokens

# Budget enforcement strategy
--budget-strategy drop      # Skip files that don't fit (default)
--budget-strategy truncate  # Force structure mode on oversized files
--budget-strategy hybrid    # Smart curation (recommended)
```

### Example Usage

```bash
# Basic budgeting - fits 100k tokens, drops lowest priority files
./pm_encoder.py . --token-budget 100k --lens architecture

# Hybrid mode - maximizes information density
./pm_encoder.py . --token-budget 50k --budget-strategy hybrid --lens architecture

# With precise token counting (requires tiktoken)
make install-extras  # Install tiktoken
./pm_encoder.py . --token-budget 100k --budget-strategy hybrid
```

### Priority Groups Configuration

Define file priorities in `.pm_encoder_config.json`:

```json
{
  "lenses": {
    "architecture": {
      "groups": [
        { "pattern": "src/core/**", "priority": 100 },
        { "pattern": "*.py", "priority": 80 },
        { "pattern": "src/utils/**", "priority": 50 },
        { "pattern": "tests/**", "priority": 10 }
      ],
      "fallback": { "priority": 50 }
    }
  }
}
```

### Budget Report Output

```
======================================================================
TOKEN BUDGET REPORT
======================================================================
Budget:     100,000 tokens
Used:       49,659 tokens (49.7%)
Remaining:  50,341 tokens
Estimation: tiktoken (cl100k_base)
Strategy:   hybrid

Files included: 25 (23 full, 2 truncated)
Files dropped:  0 (lowest priority first)

Auto-truncated files (structure mode):
  [P:100] pm_encoder.py (1,422 tokens)
  [P: 95] rust/tests/test_vectors.rs (371 tokens)
======================================================================
```

### Test Coverage

- **53 new tests** for budgeting features
- **146 total tests** passing (Python + Rust)
- Priority resolution, shorthand parsing, strategy behavior all covered

### Breaking Changes

None. All existing functionality preserved.

### Upgrade Path

```bash
git pull origin main
./pm_encoder.py --version  # Should show 1.7.0
```

---

## Commits in This Release

- `feat: Implement v1.7.0 Phase 1 - Priority Groups Schema`
- `feat: Implement v1.7.0 Phase 2 - Token Budgeting Algorithm`
- `feat: Implement v1.7.0 Phase 3 - Hybrid Budget Strategy`
- `fix: Correct truncate_content argument order in budget mode`
- `feat: Add make install-extras for optional dependencies`
- `chore: Release v1.7.0 - The Intelligence Update`
- `docs: Add Context Economics section to README (v1.7.0)`

---

*Generated by Claude Code (Opus 4.5)*
